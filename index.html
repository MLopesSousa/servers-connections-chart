<html>
<!-- 

http://blog.thinkst.com/2011/06/simple-graphs-with-arborjs.html

-->

<head>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
    crossorigin="anonymous">
  <script language="javascript" type="text/javascript" src="req.json"></script>
  <script language="javascript" type="text/javascript" src="jquery.min.js"></script>
  <script language="javascript" type="text/javascript" src="arbor.js"></script>
  <script language="javascript" type="text/javascript" src="graphics.js"></script>
  <script language="javascript" type="text/javascript" src="renderer.js"></script>
</head>

<body>
  <div class="container">
    <div class="input-group mb-3">
      <div class="input-group-prepend">
        <button class="btn btn-outline-secondary" type="button" onclick="buildGraph()">Selecionar</button>
      </div>
      <select class="custom-select" id="node">
  </select>
    </div>

    <canvas id="viewport" width="1200" height="600"></canvas>

  </div>

  <script language="javascript" type="text/javascript">
    data = "";
    sys = arbor.ParticleSystem(50, 600);
    sys.parameters({ gravity: true });
    sys.renderer = Renderer("#viewport");

    var buildSelect = function (nodes) {
      for (var i = 0; i < nodes.length; i++) {
        $("#node").append('<option>' + nodes[i] + '</option>');
      }
    }

    var getNodes = function () {
      var retorno = [];
      for (var i = 0; i < data.length; i++) {
        retorno.push(data[i]['key']);
      }

      return retorno;
    }

    var buildObject = function (dataLocal) {
      var obj = { 'nodes': {}, 'edges': {} };

      obj['nodes'][dataLocal.key] = { 'color': 'red', 'shape': 'dot' };
      obj['nodes'][dataLocal.key]['label'] = dataLocal.key;
      obj['edges'][dataLocal.key] = {};

      for (var i = 0; i < dataLocal.ips.buckets.length; i++) {
        obj['nodes'][dataLocal.ips.buckets[i].key] = { 'color': 'green', 'shape': 'dot' };
        obj['nodes'][dataLocal.ips.buckets[i].key]['label'] = dataLocal.ips.buckets[i].doc_count + " /" + dataLocal.ips.buckets[i].key;
        obj['edges'][dataLocal.key][dataLocal.ips.buckets[i].key] = {};
      }

      obj['edges'][dataLocal.key][{ length: .75, pointSize: 3 }];
      console.log(JSON.stringify(obj));
      return obj;
    }

    var getData = function (node) {
      for (var i = 0; i < data.length; i++) {
        if (data[i]['key'] == node) {
          return data[i];
        }
      }
    }

    var buildGraph = function () {
      var node = $("#node").val();

      if (node) {
        dataLocal = getData(node);
        sys.prune();
        sys.graft(buildObject(dataLocal));
      }
    }

    var getDataElasticsearch = function () {

      $.ajax({
        type: 'POST',
        traditional: true,
        url: 'http://www2.sefaz.ce.gov.br/elasticsearch/logstash-*/_search',
        data: JSON.stringify(req),
        success: function (data_raw) {
          console.log("Data Loaded: " + JSON.stringify(data_raw['aggregations']['contextos']['buckets']));
          data = data_raw['aggregations']['contextos']['buckets'];

          buildSelect(getNodes());

        }
      });


    }

    getDataElasticsearch();
    
  </script>
</body>

</html>