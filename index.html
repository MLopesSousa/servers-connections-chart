<html>
<!--

http://blog.thinkst.com/2011/06/simple-graphs-with-arborjs.html

-->

<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
    crossorigin="anonymous">
  <script language="javascript" type="text/javascript" src="./req.json"></script>
  <script language="javascript" type="text/javascript" src="./jquery.min.js"></script>
  <script language="javascript" type="text/javascript" src="./arbor.js"></script>
  <script language="javascript" type="text/javascript" src="./graphics.js"></script>
  <script language="javascript" type="text/javascript" src="./renderer.js"></script>
</head>

<body>
  <div class="container">
    <div class="input-group mb-3">
      <div class="input-group-prepend">
        <button class="btn btn-outline-secondary" type="button" onclick="buildGraph()">GO</button>
      </div>
      <select class="custom-select" id="node">
      </select>
    </div>

    <ul class="list-group">
      <li class="list-group-item list-group-item-warning">RequisiÃ§Ãµes feitas pelo Host nas ultimas 12 horas</li>
    </ul>

    <canvas id="viewport" width="1200" height="600"></canvas>

  </div>

  <script language="javascript" type="text/javascript">
    var node;
    var data;

    sys = arbor.ParticleSystem(50, 600);
    sys.parameters({ gravity: true });
    sys.renderer = Renderer("#viewport");

    // misc

    var getUrlParameter = function getUrlParameter(sParam) {
      var sPageURL = decodeURIComponent(window.location.search.substring(1)),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

      for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
          return sParameterName[1] === undefined ? true : sParameterName[1];
        }
      }
    };

    // Contruir grafico

    var buildObject = function (data) {
      var obj = { 'nodes': {}, 'edges': {} };

      obj['nodes'][data.key] = { 'color': 'red', 'shape': 'dot' };
      obj['nodes'][data.key]['label'] = data.key;
      obj['edges'][data.key] = {};

      for (var i = 0; i < data.ips.buckets.length; i++) {
        obj['nodes'][data.ips.buckets[i].key] = { 'color': 'green', 'shape': 'dot' };
        obj['nodes'][data.ips.buckets[i].key]['label'] = data.ips.buckets[i].doc_count + " /" + data.ips.buckets[i].key;
        obj['edges'][data.key][data.ips.buckets[i].key] = {};
      }

      obj['edges'][data.key][{ length: .75, pointSize: 3 }];
      return obj;
    }

    var getData = function (node) {
      for (var i = 0; i < data.length; i++) {
        if (data[i]['key'] == node) {
          return data[i];
        }
      }
    }

    var buildGraph = function () {
      var node = $("#node").val();

      if (node) {
        sys.prune();
        sys.graft(buildObject(getData(node)));
      }
    }

    // Construir home

    var buildSelect = function (nodes) {
      for (var i = 0; i < nodes.length; i++) {
        $("#node").append('<option value="' + nodes[i] +'">' + nodes[i] + '</option>');
      }
    }

    var getNodes = function (data) {
      var retorno = [];
      for (var i = 0; i < data.length; i++) {
        retorno.push(data[i]['key']);
      }

      return retorno;
    }

    var getDataElasticsearch = function () {

      $.ajax({
        type: 'POST',
        traditional: true,
        url: 'http://172.30.121.216:80/logstash-*/_search',
        data: JSON.stringify(req),
        success: function (data_raw) {
          data = data_raw['aggregations']['contextos']['buckets'];
          buildSelect(getNodes(data));

          // auto
          if(getUrlParameter("host")) {
            $("#node").val(getUrlParameter("host"));
            buildGraph();
          }
        }
      });
    }

    getDataElasticsearch();
  </script>
</body>

</html>
